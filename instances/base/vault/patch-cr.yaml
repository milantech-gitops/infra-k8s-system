---
apiVersion: "vault.banzaicloud.com/v1alpha1"
kind: "Vault"
metadata:
  name: "vault"
spec:
  # See: https://banzaicloud.com/docs/bank-vaults/cli-tool/#example-external-vault-configuration
  # The repository also contains a lot examples in the deploy/ and operator/deploy directories.
  externalConfig:
    auth:
      - type: kubernetes
        roles:
          # Allow every pod in the default namespace to use the secret kv store
          - name: default
            bound_service_account_names: ["default", "vault-secrets-webhook", "vault", "vault-system",$(AppServiceAccountName)]
            bound_service_account_namespaces: ["default", "vswh", "vault-system",$(AnnotationsCostCenter)-$(AnnotationsEnv)-$(AnnotationsCluster)]
            policies: ["allow_secrets", "allow_pki"]
            ttl: 10m
  # Default values for vault-values
  # This is a YAML-formatted file.
  # Declare variables to be passed into your templates.

  # The namespace where the operator watches for vault CRD objects, if not defined
  # all namespaces are watched
  ingress:
    annotations:
      kubernetes.io/ingress.class: traefik
      kubernetes.io/ingress.allow-https: "true"
      # traefik.ingress.kubernetes.io/auth-type: basic
      cert-manager.io/cluster-issuer: "letsencrypt-staging"
      traefik.ingress.kubernetes.io/auth-secret: vault-auth
      traefik.ingress.kubernetes.io/frontend-entry-points: "https"
      traefik.ingress.kubernetes.io/force-ssl-redirect: "true"
      traefik.ingress.kubernetes.io/ssl-passthrough: "true"
      traefik.ingress.kubernetes.io/backend-protocol: "HTTPS"
      traefik.ingress.kubernetes.io/whitelist-source-range: "127.0.0.1"
    spec:
      rules:
        - host: vault.milantech.live
          http:
            paths:
              - path: /
                backend:
                  serviceName: pbe-vault
                  servicePort: 8200
      tls:
      - hosts:
        - vault.milantech.live
        secretName: vault-milantech-view-tls

    # hosts:
    #   - host: vault.milantech.live
    #     paths: [ "/*" ]
    # tls:
    #   - secretName: vault-milantech-view-tls
    #     hosts:
    #       - vault.milantech.live